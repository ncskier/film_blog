<div>
  <h2>Related</h2>
  <ul>
    {% comment %} Parameters {% endcomment %}
    {% assign maxRelated = 3 %}
    {% assign minCommonTags =  0 %}

    {% comment %}
      0: number
      1: title
      2: url
    {% endcomment %}
    {% assign postDelimiter = ' |^-postDelimiter-^| ' %}
    {% assign tagDelimiter = '-^|tagDelimiter|^-' %}
    {% assign relatedStringArray = '' %}

    {% comment %} Search Tags {% endcomment %}
    <!-- {{ page.tags }} -->
    {% for post in site.posts %}
      {% assign sameTagCount = 0 %}
      {% assign commonTags = '' %}
      <!-- {{ post.title }} -->
      <!-- tags: {{ post.tags }} -->
      <!-- commonTags: {{ commonTags }} -->
      <!-- sameTagCount: {{ sameTagCount }} -->
      <!-- -->
      {% if post.url == page.url %}
        {% continue %}
      {% endif %}

      {% for tag in post.tags %}
        {% if page.tags contains tag %}
          <!-- contains tag: {{ tag }} -->
          {% assign sameTagCount = sameTagCount | plus: 1 %}
          {% capture tagmarkup %} <span class="label label-default">{{ tag }}</span> {% endcapture %}
          {% assign commonTags = commonTags | append: tagmarkup %}
        {% endif %}
      {% endfor %}

      {% if sameTagCount >= minCommonTags %}
        {% comment %} Add to [related] string list {% endcomment %}
        {% assign relatedStringArray = relatedStringArray
          | append: postDelimiter
          | append: sameTagCount
          | append: tagDelimiter
          | append: post.title
          | append: tagDelimiter
          | append: post.url
        %}

        <!-- <li><a href="{{ post.url | relative_url }}">{{ post.title }}</a></li> -->
        <!-- <div>
          <h5><a href="{{ site.baseurl }}{{ post.url }}">{{ post.title }}{{ commonTags }}</a></h5>
        </div> -->
      {% endif %}
    {% endfor %}

    {% comment %} Transform [related] into array {% endcomment %}
    <!-- relatedStringArray: {{ relatedStringArray }} -->
    {% assign related = relatedStringArray | split: postDelimiter | sort | reverse %}
    {% for postString in related limit:maxRelated %}
      {% if postString != '' %}
        {% assign post = postString | split: tagDelimiter %}
        {% assign postNumber = post[0] %}
        {% assign postTitle = post[1] %}
        {% assign postUrl = post[2] %}
        <!-- -->
        <!-- number: {{ postNumber }} -->
        <!-- title: {{ postTitle }} -->
        <!-- url: {{ postUrl }} -->
        <li><a href="{{ postUrl | relative_url }}">{{ postTitle }}</a></li>
      {% endif %}
    {% endfor %}

  </ul>
</div>
